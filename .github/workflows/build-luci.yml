    - name: Prepare variables
      run: |
        set -eux
        # <<< اگر برای ipq40xx/chromium می‌سازید این را ست کنید >>>
        SDK_URL="${SDK_URL:-https://downloads.openwrt.org/releases/23.05.5/targets/ipq40xx/chromium/openwrt-sdk-23.05.5-ipq40xx-chromium_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz}"
        echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV
        echo "SDK_FILE=$(basename "$SDK_URL")" >> $GITHUB_ENV

    - name: Cache SDK tarball
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/${{ env.SDK_FILE }}
        key: sdk-${{ env.SDK_FILE }}

    - name: Download & verify OpenWrt SDK (robust)
      run: |
        set -eux
        mkdir -p sdk
        if [ ! -s "${SDK_FILE}" ]; then
          # سه منبع؛ هر کدام چندبار تلاش
          MIRRORS=(
            "$SDK_URL"
            "${SDK_URL/https:\/\/downloads.openwrt.org/https:\/\/mirror-01.infra.openwrt.org}"
            "${SDK_URL/https:\/\/downloads.openwrt.org/https:\/\/sources.cdn.openwrt.org}"
          )
          ok=0
          for url in "${MIRRORS[@]}"; do
            echo ">>> trying: $url"
            for i in $(seq 1 5); do
              curl -fL --retry 10 --retry-delay 5 --connect-timeout 20 -o "${SDK_FILE}.tmp" "$url" && break || true
              sleep 5
            done
            # تست سالم بودن xz قبل از جایگزینی
            if xz -t "${SDK_FILE}.tmp"; then
              mv -f "${SDK_FILE}.tmp" "${SDK_FILE}"
              ok=1
              break
            else
              echo "Bad/partial file from $url"
              rm -f "${SDK_FILE}.tmp"
            fi
          done
          [ "$ok" = 1 ] || { echo "All mirrors failed"; exit 2; }
        fi
        # اکسترکت امن
        tar -xJf "${SDK_FILE}" --strip-components=1 -C sdk
