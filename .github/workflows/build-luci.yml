name: build-ipk

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      SDK_URL: https://downloads.openwrt.org/releases/23.05.5/targets/ipq40xx/chromium/openwrt-sdk-23.05.5-ipq40xx-chromium_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SDK
        run: |
          set -eux
          mkdir -p sdk
          curl -L --fail -o sdk.tar.xz "$SDK_URL"
          tar -C sdk --strip-components=1 -xJf sdk.tar.xz
          rm -f sdk.tar.xz

      - name: Feed setup (luci + passwall)
        run: |
          set -eux
          cd sdk

          # حذف ورودی‌های تکراری luci
          sed -i '/^src-git luci /d' feeds.conf.default || true

          # luci رسمی متناسب با 23.05
          echo "src-git luci https://github.com/openwrt/luci.git;openwrt-23.05" >> feeds.conf.default

          # پاسوال: پکیج‌ها و لوسی
          echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages" >> feeds.conf.default
          echo "src-git passwall_luci https://github.com/xiaorouji/openwrt-passwall;luci" >> feeds.conf.default

          # آپدیت فیدها (با retry ساده)
          ./scripts/feeds update luci passwall_packages passwall_luci || ./scripts/feeds update -a
          ./scripts/feeds install -a

          echo "==== feeds.conf.default ===="
          cat feeds.conf.default
          echo "==== ls feeds ===="
          ls -la feeds || true

      - name: Defconfig
        run: |
          set -eux
          cd sdk
          make defconfig

      - name: Build luci-app-passwall
        run: |
          set -eux
          cd sdk
          make package/luci-app-passwall/compile -j"$(nproc)" V=s

      - name: Collect IPKs
        run: |
          set -eux
          cd sdk
          mkdir -p ../artifacts
          find bin/packages -type f -name "*.ipk" -exec cp -v {} ../artifacts/ \; || true
          find bin/targets  -type f -name "*.ipk" -exec cp -v {} ../artifacts/ \; || true
          ls -l ../artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ipks
          path: artifacts/
          if-no-files-found: error
