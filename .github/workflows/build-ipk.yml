name: build-ipk
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # SDK مناسب تارگت خودت را بگذار (مثال x86_64). اگر ipq40xx لازم داری URL را عوض کن.
      - name: Download & extract OpenWrt SDK
        run: |
          set -eux
          SDK_URL="https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          mkdir -p sdk && curl -L "$SDK_URL" | tar -xJ --strip-components=1 -C sdk

      - name: Prepare feeds (packages + luci)
        run: |
          set -eux
          cd sdk
          # مطمئن شو تکراری نشود
          sed -i '/src-git luci /d' feeds.conf.default || true
          echo "src-git luci https://github.com/openwrt/luci.git;openwrt-23.05" >> feeds.conf.default
          # آپدیت و نصب فیدها، مخصوصاً gmp/nettle از فید packages
          ./scripts/feeds update -a
          ./scripts/feeds install gmp nettle

      - name: Defconfig + select packages
        run: |
          set -eux
          cd sdk
          make defconfig
          # پکیج‌ها را فعال کن (ماژول)
          echo 'CONFIG_PACKAGE_gmp=m'     >> .config
          echo 'CONFIG_PACKAGE_nettle=m'  >> .config
          make defconfig

      - name: Build packages (gmp, nettle)
        run: |
          set -eux
          cd sdk
          # حتماً تارگت اسم-محور استفاده کن
          make package/gmp/compile    -j"$(nproc)" V=s
          make package/nettle/compile -j"$(nproc)" V=s

      - name: Collect IPKs
        run: |
          set -eux
          cd sdk
          find bin -type f -name '*.ipk' -printf '%p\n' | tee /tmp/ipk_list.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ipks
          path: |
            sdk/bin/**/*.ipk
            /tmp/ipk_list.txt
